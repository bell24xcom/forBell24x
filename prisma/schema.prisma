generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
}

// Enhanced User model for production
model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  phone       String?  @unique
  name        String?
  role        UserRole @default(SUPPLIER)
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  company     String?
  gstNumber   String?   // optional — increases trust score if provided
  udyamNumber String?   // optional MSME Udyam Aadhar — increases trust score if provided
  trustScore  Int       @default(0) // 0-100: calculated from verification completeness
  plan        UserPlan  @default(FREE) // subscription plan
  location    String?
  avatar      String?
  preferences Json?
  lastLoginAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rfqs        RFQ[]
  quotes      Quote[]
  buyerTransactions Transaction[] @relation("BuyerTransactions")
  supplierTransactions Transaction[] @relation("SupplierTransactions")
  leads       Lead[]
  notifications Notification[]
  wallet      Wallet?
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  wallet           Wallet?
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  @@map("users")
}

// OTP Verification for authentication — standalone table, NO FK to users
// (phone may not yet have a User record at OTP send time)
model OTPVerification {
  id         String   @id @default(cuid())
  phone      String   @unique
  otp        String
  expiresAt  DateTime
  attempts   Int      @default(0)
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("otp_verifications")
}

// Category — hierarchical (level 1 = main, level 2 = subcategory)
model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  parentId    String?    @map("parent_id")
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  level       Int        @default(1)  // 1 = main category, 2 = subcategory
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)
  icon        String?    // emoji or icon name for UI
  color       String?    // hex color for UI badges
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  rfqs        RFQ[]

  @@map("categories")
}

// Webhook log for n8n / external integrations
model Webhook {
  id         String   @id @default(cuid())
  eventType  String   @map("event_type")
  payload    Json
  status     String   @default("pending")
  createdAt  DateTime @default(now())

  @@map("webhooks")
}

// RFQ (Request for Quotation) model
model RFQ {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String   // legacy string (e.g. slug); kept for backward compat
  categoryId  String?  @map("category_id")
  type        String?  // optional; used by API
  quantity    String
  unit        String   @default("units")
  minBudget   Float?
  maxBudget   Float?
  timeline    String
  requirements String?
  urgency     RFQUrgency @default(NORMAL)
  status      RFQStatus @default(ACTIVE)
  location    String?
  tags        String[]
  isPublic    Boolean  @default(true)
  expiresAt      DateTime?
  acceptedAt     DateTime?  // set when a quote is accepted (deal locked)
  completedAt    DateTime?  // set when buyer confirms deal done
  priority       Int       @default(3)
  estimatedValue Float?
  views          Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  createdBy   String   @map("created_by")
  user        User     @relation(fields: [createdBy], references: [id])
  categoryRel Category? @relation(fields: [categoryId], references: [id])
  quotes      Quote[]
  transactions Transaction[]

  @@map("rfqs")
}

// Quote model for supplier responses
model Quote {
  id          String   @id @default(cuid())
  rfqId       String   @map("rfq_id")
  supplierId  String   @map("supplier_id")
  price       Float
  quantity    String
  timeline    String
  description String?
  terms       String?
  status      QuoteStatus @default(PENDING)
  isAccepted  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rfq         RFQ      @relation(fields: [rfqId], references: [id])
  supplier    User     @relation(fields: [supplierId], references: [id])
  transactions Transaction[]

  @@map("quotes")
}

// Transaction model for payments
model Transaction {
  id          String   @id @default(cuid())
  rfqId       String   @map("rfq_id")
  quoteId     String?  @map("quote_id")
  buyerId     String   @map("buyer_id")
  supplierId  String   @map("supplier_id")
  amount      Float
  currency    String   @default("INR")
  status      TransactionStatus @default(PENDING)
  paymentMethod String?
  paymentId   String?  @map("payment_id")
  escrowId    String?  @map("escrow_id")
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rfq         RFQ      @relation(fields: [rfqId], references: [id])
  quote       Quote?   @relation(fields: [quoteId], references: [id])
  buyer       User     @relation("BuyerTransactions", fields: [buyerId], references: [id])
  supplier    User     @relation("SupplierTransactions", fields: [supplierId], references: [id])

  @@map("transactions")
}

// Lead model for potential customers
model Lead {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  company     String?
  message     String?
  source      String?
  status      LeadStatus @default(NEW)
  assignedTo  String?  @map("assigned_to")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy   String?  @map("created_by")
  user        User?    @relation(fields: [createdBy], references: [id])

  @@map("leads")
}

// Notification model
model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String
  message   String
  type      NotificationType
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// Wallet — one per user, tracks balance via WalletTransactions
model Wallet {
  id           String              @id @default(cuid())
  userId       String              @unique @map("user_id")
  balance      Float               @default(0)
  currency     String              @default("INR")
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  user         User                @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]

  @@map("wallets")
}

// WalletTransaction — each deposit/debit
model WalletTransaction {
  id          String   @id @default(cuid())
  walletId    String   @map("wallet_id")
  type        String   // "credit" | "debit"
  amount      Float
  description String?
  reference   String?  // e.g. payment ID or order ID
  createdAt   DateTime @default(now())

  wallet      Wallet   @relation(fields: [walletId], references: [id])

  @@map("wallet_transactions")
}

// Message — direct messages between users (optionally linked to an RFQ)
model Message {
  id        String   @id @default(cuid())
  fromId    String   @map("from_id")
  toId      String   @map("to_id")
  rfqId     String?  @map("rfq_id")
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  from      User     @relation("SentMessages",     fields: [fromId], references: [id])
  to        User     @relation("ReceivedMessages", fields: [toId],   references: [id])

  @@map("messages")
}

// Error log — lightweight self-hosted error tracking
model ErrorLog {
  id        String   @id @default(cuid())
  route     String
  method    String   @default("POST")
  message   String
  stack     String?
  userId    String?  @map("user_id")
  severity  String   @default("error") // "error" | "warn" | "critical"
  meta      Json?    // extra context (phone, rfqId, etc.)
  createdAt DateTime @default(now())

  @@map("error_logs")
}

// Credit system for lead unlocking
model UserCredits {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  credits   Int      @default(0)
  spent     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_credits")
}

model CreditPurchase {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  credits     Int
  amount      Float
  razorpayId  String?  @map("razorpay_id")
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("credit_purchases")
}

// Lead-Supplier unlock tracking
model LeadSupplier {
  id         String    @id @default(cuid())
  leadId     String    @map("lead_id")
  supplierId String    @map("supplier_id")
  unlocked   Boolean   @default(false)
  unlockedAt DateTime?
  credits    Int       @default(0)
  createdAt  DateTime  @default(now())

  @@map("lead_suppliers")
}

// Enums
enum UserRole {
  SUPPLIER
  BUYER
  ADMIN
  AGENT
}

enum UserPlan {
  FREE
  PRO
  ENTERPRISE
}

enum RFQStatus {
  DRAFT
  ACTIVE
  QUOTED
  ACCEPTED        // quote accepted — deal locked, in-progress
  IN_PROGRESS     // buyer confirmed work started
  COMPLETED       // buyer confirmed deal done
  CANCELLED
  EXPIRED
  CLOSED_EXTERNAL // deal completed outside platform (manual override)
}

enum RFQUrgency {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  RFQ_CREATED
  QUOTE_RECEIVED
  QUOTE_ACCEPTED
  DEAL_CHECK      // 7-day follow-up: "Was this deal completed?"
  DEAL_CONFIRMED  // buyer confirmed deal complete
  TRANSACTION_UPDATE
  SYSTEM_ALERT
}

// New models for Phase 3A
model Wallet {
  id           String              @id @default(cuid())
  userId       String              @unique @map("user_id")
  balance      Float               @default(0)
  currency     String              @default("INR")
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]
  @@map("wallets")
}

model WalletTransaction {
  id          String   @id @default(cuid())
  walletId    String   @map("wallet_id")
  type        String
  amount      Float
  description String?
  reference   String?
  createdAt   DateTime @default(now())
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  @@map("wallet_transactions")
}

model Message {
  id        String   @id @default(cuid())
  fromId    String   @map("from_id")
  toId      String   @map("to_id")
  rfqId     String?  @map("rfq_id")
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  from      User     @relation("SentMessages",     fields: [fromId], references: [id])
  to        User     @relation("ReceivedMessages", fields: [toId],   references: [id])
  @@map("messages")
}